<!DOCTYPE html>
<html>
<head>
	<title>Leaflet - OS Openspace Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.4/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.4/leaflet.ie.css" />
<![endif]-->
	
</head>
<body>
	<div id="map" style="width: 800px; height: 600px"></div>

	<script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
        <script src="proj4-js.js"></script><!-- proj4js -->
        <script src="proj4-leaf.js"></script><!-- proj4leaflet -->
        <script src="openspace.js"></script><!-- os layer -->
        <script>
            
            
window.onload = function(){
    
var res = [2500, 1000, 500, 200, 100, 50, 25, 10, 5, 4, 2.5, 2, 1];


var start = new L.LatLng(51.503, -0.06);//ldn
//var start = new L.LatLng(50.930960,-1.450141);//os
//var start = new L.LatLng(-7.5600, 49.9600);//0,0

var bounds = new L.LatLngBounds(new L.LatLng(-7.5600, 49.9600), new L.LatLng(1.7800, 60.8400));//-7.5600, 49.9600, 1.7800, 60.8400

var scaleFn = function(zoom) {

    var tileRes = res[zoom-1];
    var scale = 1/tileRes;

    console.log("res: ",tileRes);
    console.log("z: ",zoom);
    console.log("scale: ",scale);
    
    return scale;
    
};

/*
* proj => minx, miny -> 1393.0196, 13494.9764  
*   max-x, max-y -> 671196.3657, 1230275.0454
*   xmin-7.5600, ymin49.9600, xmax1.7800, ymax60.8400
*   0,0,700000,1300000
*/
var osgbTransform = new L.Transformation(1, 0, -1, 0);
var osgbCrs = L.CRS.proj4js('EPSG:27700',
    "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs",
    osgbTransform);

    
var map = new L.Map('map', {
  crs: osgbCrs,
  minZoom: 1,
  maxZoom: 13,
  continuousWorld: true //required on both tilelayer and map?!
});
map.options.crs.scale = scaleFn; // required by Leaflet >0.4

var os200 = new L.TileLayer.OS("API_KEY", { tileSize: 200 });
var os250 = new L.TileLayer.OS("API_KEY", { tileSize: 250 });

map.addLayer(os200);
map.setView(start, 5);
//L.control.scale().addTo(map); //not sure how correct this is. Dont rely on it.


function onMapClick(e) {

    alert("You clicked the map at " + e.latlng);
}

map.on('click', onMapClick);

var canvasTiles = L.tileLayer.canvas({tms:true, noWrap: true, continuousWorld: true});
canvasTiles.drawTile = function(canvas, tilePoint, zoom) {
     var ctx = canvas.getContext('2d');
     ctx.strokeStyle = ctx.fillStyle = "blue";
     ctx.rect(0,0, 256,256);
     ctx.stroke();
     ctx.fillText('(' + tilePoint.x + ', ' + tilePoint.y + ')',5,10);
 };
 //map.addLayer(canvasTiles);    
    
    //demo stuff
L.marker([51.5, -0.02]).addTo(map)
    .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

L.circle([51.508, -0.11], 500, {
    color: 'red',
    fillColor: '#f03',
    fillOpacity: 0.5
}).addTo(map).bindPopup("I am a circle.");

L.polygon([
    [51.509, -0.08],
    [51.503, -0.06],
    [51.51, -0.047]
]).addTo(map).bindPopup("I am a polygon.");



/*
* Hack to adjust the underlying tilesize setting of the layer - TODO: fix
*/
function adjustTileSize(e) {
    var z = e.target._animateToZoom;//note this is the current res/zoom - ensure not previous val
    var r = res[z-1];
    if(r < 5 && r !== 2.5){
        map.removeLayer(os200);
        map.addLayer(os250);
        
    }else{
        map.removeLayer(os250);
        map.addLayer(os200);
    };

    //os.setOsTileSize(tileSize);//adjust the layer tilesize :( doesnt seem to work. TODO: fix
    
}
map.on('zoomend', adjustTileSize);
    
}            
//end           
            
            
            
        </script>

</body>
</html>